{% extends "main/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Административный дэшборд" %}{% endblock title %}

{% block content %}
<section class="admin-dashboard-section">
  <div class="admin-dashboard-container">
    <h1 class="admin-dashboard-title">{% trans "Административный дэшборд аукционов" %}</h1>

    <div class="admin-dashboard-stats admin-dashboard-card">
      <h2>{% trans "Общая статистика" %}</h2>
      <ul class="admin-dashboard-list">
        <li><strong>{% trans "Общее количество аукционов:" %}</strong> {{ total_auctions }}</li>
        <li><strong>{% trans "Подтвержденные аукционы:" %}</strong> {{ approved_auctions }}</li>
        <li><strong>{% trans "Ожидающие подтверждения:" %}</strong> {{ pending_auctions }}</li>
        <li><strong>{% trans "Отклонённые аукционы:" %}</strong> {{ rejected_auctions }}</li>
        <li><strong>{% trans "Завершённые аукционы:" %}</strong> {{ completed_auctions }}</li>
        <li><strong>{% trans "Лоты на изменении:" %}</strong> {{ change_requested_auctions }}</li>
        <li><strong>{% trans "Средняя сумма ставки:" %}</strong> {{ avg_bid|default:_("Нет ставок") }}</li>
      </ul>
    </div>

    <div class="admin-dashboard-charts">
      <div class="admin-dashboard-card">
        <h2>{% trans "Активность аукционов за последние 30 дней" %}</h2>
        <canvas id="lineChart"></canvas>
      </div>
      <div class="admin-dashboard-card">
        <h2>{% trans "Распределение аукционов по статусам" %}</h2>
        <canvas id="pieChart"></canvas>
      </div>
    </div>

    <div class="admin-dashboard-pending admin-dashboard-card">
      <h2>{% trans "Лоты, ожидающие подтверждения" %}</h2>
      <table class="admin-dashboard-table">
        <thead>
          <tr>
            <th>{% trans "Название лота" %}</th>
            <th>{% trans "Продавец" %}</th>
            <th>{% trans "Стартовая цена" %}</th>
            <th>{% trans "Дата создания" %}</th>
            <th>{% trans "Действия" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for lot in pending_list %}
          <tr>
            <td>
              <a href="#" class="auction-modal-link" data-id="{{ lot.id }}">{{ lot.title }}</a>
            </td>
            <td>{{ lot.seller.username }}</td>
            <td>{{ lot.starting_price }}</td>
            <td>{{ lot.created_at|date:"d.m.Y H:i" }}</td>
            <td>
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="auction_id" value="{{ lot.id }}">
                <button type="submit" name="approve" class="admin-dashboard-btn admin-dashboard-btn-success">{% trans "Подтвердить" %}</button>
                <button type="submit" name="reject" class="admin-dashboard-btn admin-dashboard-btn-danger">{% trans "Отклонить" %}</button>
              </form>
              <button class="admin-dashboard-btn admin-dashboard-btn-warning" onclick="openChangeModal('{{ lot.id }}', '{{ lot.title|escapejs }}')">{% trans "Запрос на изменение" %}</button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="admin-dashboard-empty">{% trans "Нет лотов в ожидании" %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="admin-dashboard-change-requests admin-dashboard-card">
      <h2>{% trans "Лоты на изменении" %}</h2>
      <table class="admin-dashboard-table">
        <thead>
          <tr>
            <th>{% trans "Название лота" %}</th>
            <th>{% trans "Продавец" %}</th>
            <th>{% trans "Стартовая цена" %}</th>
            <th>{% trans "Дата создания" %}</th>
            <th>{% trans "Действия" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for lot in change_requested_list %}
          <tr>
            <td>
              <a href="#" class="auction-modal-link" data-id="{{ lot.id }}">{{ lot.title }}</a>
            </td>
            <td>{{ lot.seller.username }}</td>
            <td>{{ lot.starting_price }}</td>
            <td>{{ lot.created_at|date:"d.m.Y H:i" }}</td>
            <td>
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="auction_id" value="{{ lot.id }}">
                <button type="submit" name="approve" class="admin-dashboard-btn admin-dashboard-btn-success">{% trans "Подтвердить" %}</button>
                <button type="submit" name="reject" class="admin-dashboard-btn admin-dashboard-btn-danger">{% trans "Отклонить" %}</button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="admin-dashboard-empty">{% trans "Нет лотов на изменении" %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<div class="modal fade" id="auctionModal" tabindex="-1" role="dialog" aria-labelledby="auctionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content" id="auction-modal-content">
    </div>
  </div>
</div>

<div class="modal fade" id="changeRequestModal" tabindex="-1" role="dialog" aria-labelledby="changeRequestModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="post" action="{% url 'auction:admin_dashboard' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="changeRequestModalLabel">{% trans "Запрос на изменение" %}</h5>
          <button type="button" class="close" data-bs-dismiss="modal" aria-label="Закрыть">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="auction_id" id="change-auction-id">
          <div class="form-group">
            <label for="admin-comment">{% trans "Комментарий для пользователя" %}</label>
            <textarea class="form-control" name="admin_comment" id="admin-comment" rows="4" placeholder="{% trans 'Опишите, что нужно исправить' %}"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Отмена" %}</button>
          <button type="submit" name="request_change" class="btn btn-warning">{% trans "Отправить запрос" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}">
{% endblock extra_css %}

{% block extra_js %}
<script src="{% static 'bootstrap/js/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script id="dashboard-data" type="application/json">{{ dashboard_data_json|safe }}</script>
<script src="{% static 'js/dashboard_charts.js' %}"></script>

<script>
  $(document).ready(function(){
      $('.auction-modal-link').click(function(e) {
          e.preventDefault();
          var auctionId = $(this).data('id');
          $.ajax({
              url: "{% url 'auction:modal_detail' 0 %}".replace("0", auctionId),
              method: "GET",
              success: function(data) {
                  $('#auction-modal-content').html(data.html);
                  var modal = new bootstrap.Modal(document.getElementById('auctionModal'));
                  modal.show();
              },
              error: function(xhr, status, error) {
                  console.error("Ошибка загрузки деталей:", error);
              }
          });
      });
  });
  function openChangeModal(auctionId, auctionTitle) {
      $('#change-auction-id').val(auctionId);
      $('#changeRequestModalLabel').text("Запрос на изменение: " + auctionTitle);
      var modal = new bootstrap.Modal(document.getElementById('changeRequestModal'));
      modal.show();
  }
</script>
{% endblock extra_js %}
